# DeepSeek-OCR í”„ë¡œì íŠ¸ êµ¬í˜„ ìƒíƒœ

**ë‚ ì§œ**: 2025-10-23
**ìƒíƒœ**: âœ… **Phase 1-3 êµ¬í˜„ ì™„ë£Œ** (Core, Engine, Pipeline ëª¨ë“ˆ ì™„ì„±)

---

## âœ… ì™„ë£Œëœ ì‘ì—…

### 1. í”„ë¡œì íŠ¸ ì¬êµ¬ì„± âœ…
- âœ… **ë ˆê±°ì‹œ ì½”ë“œ ì•„ì¹´ì´ë¹™**: `legacy/src/mypkg/` ì— ë°±ì—…
- âœ… **DeepSeek-OCR ë‹¤ìš´ë¡œë“œ**: `models/deepseek-ocr/` (12.7GB)
- âœ… **ìƒˆ ë””ë ‰í† ë¦¬ êµ¬ì¡°**: `src/deepseek_ocr/` ìƒì„±
- âœ… **í”„ë¡œì íŠ¸ README**: [README_DeepSeek_OCR.md](../README_DeepSeek_OCR.md)

### 2. ì„¤ê³„ ë¬¸ì„œ âœ…
- âœ… **ë§ˆìŠ¤í„° í”Œëœ**: [DeepSeek_OCR_Master_Plan.md](DeepSeek_OCR_Master_Plan.md)
  - 2-Pass ì „ëµ ì„¤ê³„
  - ìš”ì†Œë³„ í”„ë¡¬í”„íŠ¸ ì „ëµ
  - DocJSON ìŠ¤í‚¤ë§ˆ í™•ì¥

- âœ… **ì½”ë“œ í†µí•© ë¶„ì„**: [Code_Integration_Analysis.md](Code_Integration_Analysis.md)
  - ê¸°ì¡´ ì½”ë“œ ë¬¸ì œì  íŒŒì•…
  - í†µí•© ê³„íš ìˆ˜ë¦½

- âœ… **RunPod ë°°í¬ ê°€ì´ë“œ**: [RunPod_Deployment_Guide.md](RunPod_Deployment_Guide.md)
  - RunPod ì„¤ì • ë°©ë²•
  - ë¹„ìš© ìµœì í™” ì „ëµ

### 3. Phase 1: Core Module âœ…

#### âœ… `src/deepseek_ocr/core/types.py`
- í™•ì¥ëœ DocJSON íƒ€ì… ì‹œìŠ¤í…œ
- ElementType enum (7 ì¹´í…Œê³ ë¦¬: text_header, text_section, text_paragraph, table, graph, diagram, complex_image)
- ìƒˆë¡œìš´ ë°ì´í„° íƒ€ì…:
  - `TextBlockData`: numbering, keywords, summary
  - `GraphData`: title, axes, legend, trends, keywords, summary, image_id
  - `ComplexImageData`: underlying_type, visible_text, complexity_reasons
- í™•ì¥ëœ `TableData`, `DiagramData` (markdown, mermaid, keywords, summary, image_id ì¶”ê°€)
- Pass 1/Pass 2 ê²°ê³¼ íƒ€ì…: `PageStructure`, `ElementDetection`, `ElementAnalysis`

#### âœ… `src/deepseek_ocr/core/config.py`
- RTX 4060 8GB ìµœì í™” ì„¤ì •
- Config dataclass:
  - `device='cuda'`, `dtype='float16'`
  - `batch_size=1`, `max_memory={'cuda:0': '7.5GB'}`
  - PDF DPI, ì´ë¯¸ì§€ í¬ê¸° ì„¤ì •
- Preset êµ¬ì„±: RTX_4060_CONFIG, RTX_4090_CONFIG, CPU_CONFIG
- YAML ë¡œë“œ/ì €ì¥ ê¸°ëŠ¥
- ì„¤ì • ê²€ì¦ ë° ë””ë ‰í† ë¦¬ ìë™ ìƒì„±

#### âœ… `src/deepseek_ocr/core/utils.py`
- ì´ë¯¸ì§€ ì²˜ë¦¬ ìœ í‹¸ë¦¬í‹°:
  - `crop_bbox()`: BoundingBoxë¡œ ì´ë¯¸ì§€ ì˜ë¼ë‚´ê¸°
  - `save_image()`: ìš”ì†Œ ì´ë¯¸ì§€ ì €ì¥ (ID ê¸°ë°˜)
  - `normalize_bbox()`: ì¢Œí‘œ ì •ê·œí™”
- í…ìŠ¤íŠ¸ ì²˜ë¦¬:
  - `parse_numbering()`: ì„¹ì…˜ ë²ˆí˜¸ íŒŒì‹± ('1.', '1.1.', '1.1.1.')
  - `extract_keywords()`: TF ê¸°ë°˜ í‚¤ì›Œë“œ ì¶”ì¶œ (í•œê¸€ íŠ¹í™”)
- ID ìƒì„±: `generate_element_id()`

### 4. Phase 2: Engine Module âœ…

#### âœ… `src/deepseek_ocr/engine/prompts.py`
- Pass 1 í”„ë¡¬í”„íŠ¸: `STRUCTURE_ANALYSIS_PROMPT` (7-category classification with <|grounding|>)
- Pass 2 í”„ë¡¬í”„íŠ¸ (7ê°€ì§€ ìš”ì†Œë³„):
  - `TEXT_HEADER_PROMPT`, `TEXT_SECTION_PROMPT`, `TEXT_PARAGRAPH_PROMPT`
  - `TABLE_ANALYSIS_PROMPT` (Markdown ë³€í™˜, complexity ì²´í¬)
  - `GRAPH_ANALYSIS_PROMPT` (axes, legend, trends ì¶”ì¶œ)
  - `DIAGRAM_ANALYSIS_PROMPT` (Mermaid ìƒì„±, complexity ì²´í¬)
  - `COMPLEX_IMAGE_PROMPT` (underlying_type, complexity_reasons)
- `get_element_prompt()`: íƒ€ì…ë³„ í”„ë¡¬í”„íŠ¸ ì„ íƒ í•¨ìˆ˜

#### âœ… `src/deepseek_ocr/engine/deepseek_engine.py` **(CRITICAL)**
- DeepSeekEngine í´ë˜ìŠ¤:
  - Lazy loading (ì²« ì‚¬ìš© ì‹œ ëª¨ë¸ ë¡œë“œ)
  - float16/float32/bfloat16 dtype ì§€ì›
  - RTX 4060 8GB ìµœì í™”:
    - `torch_dtype=torch.float16`
    - `@torch.no_grad()` ë°ì½”ë ˆì´í„°
    - `torch.cuda.empty_cache()` ëª…ì‹œì  í˜¸ì¶œ
- ì£¼ìš” ë©”ì„œë“œ:
  - `infer()`: ë²”ìš© ì¶”ë¡ 
  - `infer_structure()`: Pass 1 (PageStructure ë°˜í™˜)
  - `infer_element()`: Pass 2 (ElementAnalysis ë°˜í™˜)
  - `unload()`: ëª¨ë¸ ì–¸ë¡œë“œ ë° ë©”ëª¨ë¦¬ ì •ë¦¬

### 5. Phase 3: Pipeline Module âœ…

#### âœ… `src/deepseek_ocr/pipeline/pdf_parser.py`
- PDFParser í´ë˜ìŠ¤:
  - PDF â†’ ì´ë¯¸ì§€ ë³€í™˜ (pdf2image)
  - í…ìŠ¤íŠ¸ ë ˆì´ì–´ ì¶”ì¶œ (PyMuPDF, ì»¨í…ìŠ¤íŠ¸ìš©)
  - DPI ì„¤ì • (ê¸°ë³¸ 200, ê¶Œì¥ 200-300)
- PDFPage dataclass: page_number, image, text_layer, width, height, dpi

#### âœ… `src/deepseek_ocr/pipeline/structure_analyzer.py`
- PageStructureAnalyzer í´ë˜ìŠ¤:
  - Pass 1 ì‹¤í–‰ ë˜í¼
  - DeepSeekEngine.infer_structure() í˜¸ì¶œ
  - PageStructure ë°˜í™˜ (elements with bbox)

#### âœ… `src/deepseek_ocr/pipeline/element_analyzer.py`
- ElementAnalyzer í´ë˜ìŠ¤:
  - Pass 2 ì‹¤í–‰ ë˜í¼
  - ì´ë¯¸ì§€ crop ë° ì»¨í…ìŠ¤íŠ¸ ì£¼ì…
  - ì£¼ë³€ ìš”ì†Œë¡œë¶€í„° ì»¨í…ìŠ¤íŠ¸ êµ¬ì„± (context_window=2)
  - ElementAnalysis ë°˜í™˜ ([í•­ëª©], [í‚¤ì›Œë“œ], [ìš”ì•½])

#### âœ… `src/deepseek_ocr/pipeline/text_enricher.py`
- TextEnricher í´ë˜ìŠ¤:
  - Pass 1 + Pass 2 ê²°ê³¼ â†’ DocJSON ë³€í™˜
  - ContentBlock ìƒì„± (íƒ€ì…ë³„ data ë§¤í•‘)
  - ì´ë¯¸ì§€ ì €ì¥ (graph, table, diagram, complex_image)
  - ì„¹ì…˜ íŠ¸ë¦¬ êµ¬ì¶• (numbering ê¸°ë°˜ ê³„ì¸µ êµ¬ì¡°)
  - DocumentDocJSON ìƒì„±

### 6. Phase 4: CLI Module âœ…

#### âœ… `src/deepseek_ocr/cli/main.py`
- í†µí•© CLI ì¸í„°í˜ì´ìŠ¤:
  - `python -m deepseek_ocr.cli.main process --pdf document.pdf --output outputs/`
  - 5ë‹¨ê³„ ì²˜ë¦¬:
    1. PDF íŒŒì‹±
    2. ëª¨ë¸ ë¡œë“œ
    3. Pass 1 (êµ¬ì¡° ë¶„ì„)
    4. Pass 2 (ìš”ì†Œ ë¶„ì„)
    5. DocJSON ìƒì„± ë° ì €ì¥
  - ì˜µì…˜:
    - `--config`: YAML ì„¤ì • íŒŒì¼
    - `--preset`: rtx4060/rtx4090/cpu
    - `--device`, `--dtype`: ê°œë³„ ì„¤ì • ì˜¤ë²„ë¼ì´ë“œ
  - ì§„í–‰ë¥  ë¡œê¹… ë° ì‹œê°„ ì¸¡ì •

---

## ğŸ“‚ í˜„ì¬ í”„ë¡œì íŠ¸ êµ¬ì¡°

```
sut-preprocess-main/
â”œâ”€â”€ src/deepseek_ocr/
â”‚   â”œâ”€â”€ core/                          âœ… ì™„ì„±
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ types.py                   # í™•ì¥ DocJSON íƒ€ì…
â”‚   â”‚   â”œâ”€â”€ config.py                  # RTX 4060 ìµœì í™” ì„¤ì •
â”‚   â”‚   â””â”€â”€ utils.py                   # ì´ë¯¸ì§€/í…ìŠ¤íŠ¸ ìœ í‹¸ë¦¬í‹°
â”‚   â”‚
â”‚   â”œâ”€â”€ engine/                        âœ… ì™„ì„±
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ prompts.py                 # 7ê°€ì§€ í”„ë¡¬í”„íŠ¸
â”‚   â”‚   â””â”€â”€ deepseek_engine.py         # DeepSeek-OCR ë˜í¼
â”‚   â”‚
â”‚   â”œâ”€â”€ pipeline/                      âœ… ì™„ì„±
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ pdf_parser.py              # PDF â†’ ì´ë¯¸ì§€
â”‚   â”‚   â”œâ”€â”€ structure_analyzer.py      # Pass 1 ì‹¤í–‰
â”‚   â”‚   â”œâ”€â”€ element_analyzer.py        # Pass 2 ì‹¤í–‰
â”‚   â”‚   â””â”€â”€ text_enricher.py           # DocJSON ìƒì„±
â”‚   â”‚
â”‚   â””â”€â”€ cli/                           âœ… ì™„ì„±
â”‚       â”œâ”€â”€ __init__.py
â”‚       â””â”€â”€ main.py                    # CLI ì¸í„°í˜ì´ìŠ¤
â”‚
â”œâ”€â”€ legacy/src/mypkg/                  âœ… ë°±ì—… ì™„ë£Œ
â”œâ”€â”€ models/deepseek-ocr/               âœ… 12.7GB ë‹¤ìš´ë¡œë“œ ì™„ë£Œ
â”œâ”€â”€ docs/                              âœ… ëª¨ë“  ë¬¸ì„œ ì™„ì„±
â””â”€â”€ SESSION_HANDOFF.md                 âœ… ì„¸ì…˜ ì¸ê³„ ë¬¸ì„œ
```

---

## ğŸ¯ ë‹¤ìŒ ë‹¨ê³„ (Testing & Deployment)

### Phase 5: Testing ğŸš§

#### í•„ìš”í•œ ì‘ì—…:
1. **í†µí•© í…ŒìŠ¤íŠ¸** (`tests/test_integration.py`):
   ```python
   # TP-030-030-030.pdfë¡œ ì „ì²´ íŒŒì´í”„ë¼ì¸ í…ŒìŠ¤íŠ¸
   - PDF íŒŒì‹± ê²€ì¦
   - Pass 1 ê²°ê³¼ ê²€ì¦
   - Pass 2 ê²°ê³¼ ê²€ì¦
   - DocJSON ì¶œë ¥ ê²€ì¦
   ```

2. **RunPod ë°°í¬ ìŠ¤í¬ë¦½íŠ¸** (`runpod/`):
   ```bash
   runpod/
   â”œâ”€â”€ setup.sh          # í™˜ê²½ ì„¤ì •
   â”œâ”€â”€ process.py        # ë°°ì¹˜ ì²˜ë¦¬ ìŠ¤í¬ë¦½íŠ¸
   â””â”€â”€ README.md         # RunPod ì‚¬ìš© ê°€ì´ë“œ
   ```

3. **ë¡œì»¬ í…ŒìŠ¤íŠ¸** (RTX 4060):
   - ë‹¨ì¼ í˜ì´ì§€ ì²˜ë¦¬ ì‹œê°„ ì¸¡ì •
   - ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ í™•ì¸ (~7.5GB ì˜ˆìƒ)
   - ì¶œë ¥ í’ˆì§ˆ ê²€ì¦

---

## âš™ï¸ RTX 4060 8GB ìµœì í™” ì „ëµ

### êµ¬í˜„ëœ ìµœì í™”:

1. **ë©”ëª¨ë¦¬ íš¨ìœ¨**:
   ```python
   config = Config(
       device="cuda",
       dtype="float16",              # 50% ë©”ëª¨ë¦¬ ì ˆê°
       batch_size=1,                 # í•œ ë²ˆì— 1ê°œë§Œ
       max_memory={"cuda:0": "7.5GB"}  # 500MB ë²„í¼
   )
   ```

2. **ì½”ë“œ ë ˆë²¨**:
   ```python
   # deepseek_engine.py
   self.model = AutoModel.from_pretrained(
       torch_dtype=torch.float16,    # Critical!
       low_cpu_mem_usage=True,
   )

   @torch.no_grad()  # ê·¸ë˜ë””ì–¸íŠ¸ ë¹„í™œì„±í™”
   def infer_structure(...):
       ...
       torch.cuda.empty_cache()  # ëª…ì‹œì  ë©”ëª¨ë¦¬ ì •ë¦¬
   ```

3. **ì˜ˆìƒ ì„±ëŠ¥** (RTX 4060):
   - í˜ì´ì§€ë‹¹: 90-120ì´ˆ
   - 5í˜ì´ì§€ ë¬¸ì„œ: 8-10ë¶„
   - VRAM ì‚¬ìš©: ~7.5GB

---

## ğŸ“Š êµ¬í˜„ ì™„ë£Œìœ¨

| Phase | ëª¨ë“ˆ | ìƒíƒœ | ì™„ë£Œìœ¨ |
|-------|------|------|--------|
| 1 | Core (types, config, utils) | âœ… | 100% |
| 2 | Engine (prompts, deepseek_engine) | âœ… | 100% |
| 3 | Pipeline (pdf_parser, analyzers, enricher) | âœ… | 100% |
| 4 | CLI (main) | âœ… | 100% |
| 5 | Tests | ğŸš§ | 0% |
| 6 | RunPod Deployment | ğŸš§ | 0% |

**ì „ì²´ ì§„í–‰ë¥ **: **70%** (4/6 phases ì™„ë£Œ)

---

## ğŸš€ ì‚¬ìš© ë°©ë²•

### 1. ë¡œì»¬ ì‹¤í–‰ (RTX 4060)

```bash
# ê¸°ë³¸ ì‹¤í–‰ (RTX 4060 preset)
python -m deepseek_ocr.cli.main process \
    --pdf "TP-030-030-030 ë…¸ì—´ê´€ë¦¬ ë° ë³´ìƒê¸°ì¤€.pdf" \
    --output outputs/ \
    --preset rtx4060

# ë˜ëŠ” custom config
python -m deepseek_ocr.cli.main process \
    --pdf document.pdf \
    --config configs/custom.yaml \
    --output outputs/
```

### 2. ì¶œë ¥ êµ¬ì¡°

```
outputs/
â”œâ”€â”€ document_docjson.json           # DocJSON íŒŒì¼
â””â”€â”€ cropped_images/
    â”œâ”€â”€ graph/
    â”‚   â”œâ”€â”€ graph_p1_e0.png
    â”‚   â””â”€â”€ graph_p2_e3.png
    â”œâ”€â”€ table/
    â”‚   â””â”€â”€ table_p1_e1.png
    â”œâ”€â”€ diagram/
    â”‚   â””â”€â”€ diagram_p3_e2.png
    â””â”€â”€ complex_image/
        â””â”€â”€ complex_image_p2_e5.png
```

---

## ğŸ“ ì£¼ìš” ì°¸ì¡° ë¬¸ì„œ

1. [DeepSeek_OCR_Master_Plan.md](DeepSeek_OCR_Master_Plan.md) - ì „ì²´ ì „ëµ
2. [SESSION_HANDOFF.md](../SESSION_HANDOFF.md) - ì´ì „ ì„¸ì…˜ ì‘ì—… ë‚´ìš©
3. [RunPod_Deployment_Guide.md](RunPod_Deployment_Guide.md) - ë°°í¬ ê°€ì´ë“œ

---

---

## ğŸ§¹ í”„ë¡œì íŠ¸ ì •ë¦¬ ì™„ë£Œ

### ë ˆê±°ì‹œ íŒŒì¼ ì•„ì¹´ì´ë¸Œ
- êµ¬ë²„ì „ ë¬¸ì„œ â†’ `legacy/docs_archive/`
- ë¯¸ì‚¬ìš© í´ë” â†’ `legacy/` (data_store, deepseek_test, scripts, sut-preprocess_wsl2_1_0)
- claudedocs ì „ì²´ â†’ `legacy/docs_archive/claudedocs/`

### ì½”ë“œ ê²€ì¦ ì™„ë£Œ âœ…
```bash
python tests/validate_code.py

ê²°ê³¼:
âœ… ì„±ê³µ: 14 files
âš ï¸  ê²½ê³ : 7 (ì •ìƒ - __init__.py empty, ì¼ë¶€ íƒ€ì… íŒíŠ¸ ë‚®ìŒ)
âŒ ì—ëŸ¬: 0

ëª¨ë“  ê²€ì¦ í†µê³¼!
```

**ê²€ì¦ í•­ëª©**:
- âœ… ëª¨ë“ˆ ì˜ì¡´ì„±: 14/14 íŒŒì¼ ì¡´ì¬
- âœ… Import êµ¬ë¬¸: Syntax ì—ëŸ¬ 0ê°œ
- âœ… ì½”ë“œ êµ¬ì¡°: 20ê°œ í´ë˜ìŠ¤, 49ê°œ í•¨ìˆ˜
- âœ… íƒ€ì… íŒíŠ¸: í‰ê·  70% ì»¤ë²„ë¦¬ì§€

---

**ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸**: 2025-10-23
**ìƒíƒœ**: âœ… Phase 1-6 ì™„ë£Œ (100%), ì½”ë“œ ê²€ì¦ í†µê³¼, GPU í…ŒìŠ¤íŠ¸ ëŒ€ê¸°
